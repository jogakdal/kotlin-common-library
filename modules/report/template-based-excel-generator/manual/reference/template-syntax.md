# TBEG 템플릿 문법 레퍼런스

## 목차
1. [변수 치환](#1-변수-치환)
2. [반복 처리](#2-반복-처리)
   - [명시적 파라미터 형식](#26-명시적-파라미터-형식)
   - [빈 컬렉션 처리 (empty)](#27-빈-컬렉션-처리-empty)
   - [관련 요소 자동 조정](#28-관련-요소-자동-조정)
3. [이미지 삽입](#3-이미지-삽입)
4. [컬렉션 크기](#4-컬렉션-크기)
5. [수식 내 변수](#5-수식-내-변수)
6. [수식 형태 마커](#6-수식-형태-마커)

---

TBEG은 템플릿의 마커(`${...}`, `=TBEG_...()`)를 데이터로 치환합니다. 정상적으로 처리된 마커는 결과 파일에 나타나지 않습니다.

---

## 1. 변수 치환

### 1.1 단순 변수

**문법**: `${변수명}`

템플릿의 `${변수명}` 마커를 데이터의 해당 키 값으로 치환합니다.

#### 템플릿

|   | A      | B         |
|---|--------|-----------|
| 1 | 제목     | ${title}  |
| 2 | 작성일    | ${date}   |
| 3 | 작성자    | ${author} |

#### 데이터

```kotlin
mapOf(
    "title" to "월간 보고서",
    "date" to "2026-01-15",
    "author" to "황용호"
)
```

#### 결과

|   | A   | B          |
|---|-----|------------|
| 1 | 제목  | 월간 보고서     |
| 2 | 작성일 | 2026-01-15 |
| 3 | 작성자 | 황용호        |

### 1.2 복합 텍스트

하나의 셀에 여러 변수와 텍스트를 조합할 수 있습니다.

```
작성자: ${author} (${department})
```

---

## 2. 반복 처리

### 2.1 기본 반복 (DOWN 방향)

**문법**: `${repeat(컬렉션, 범위, 변수)}`

컬렉션의 각 아이템에 대해 지정된 범위를 아래로 반복합니다.

#### 템플릿

|   | A                                  | B               | C             |
|---|------------------------------------|-----------------|---------------|
| 1 | ${repeat(employees, A2:C2, emp)}   |                 |               |
| 2 | ${emp.name}                        | ${emp.position} | ${emp.salary} |

#### 데이터

```kotlin
data class Employee(val name: String, val position: String, val salary: Int)

mapOf(
    "employees" to listOf(
        Employee("황용호", "부장", 8000),
        Employee("한용호", "과장", 6500),
        Employee("홍용호", "대리", 4500)
    )
)
```

#### 결과

|   | A   | B  | C     |
|---|-----|----|-------|
| 1 |     |    |       |
| 2 | 황용호 | 부장 | 8,000 |
| 3 | 한용호 | 과장 | 6,500 |
| 4 | 홍용호 | 대리 | 4,500 |

> **마커 위치**: `${repeat(...)}` 마커는 반복 범위 밖이라면 워크북 내 어디에 있어도 됩니다(다른 시트도 가능). 범위 파라미터로 지정된 영역이 반복됩니다.

### 2.2 다중 행 반복

범위에 여러 행을 지정하면 다중 행이 함께 반복됩니다.

#### 템플릿

|   | A                                | B                   |
|---|----------------------------------|---------------------|
| 1 | ${repeat(employees, A2:B3, emp)} |                     |
| 2 | 이름: ${emp.name}                  | 직급: ${emp.position} |
| 3 | 급여: ${emp.salary}                |                     |

### 2.3 오른쪽 방향 반복 (RIGHT)

**문법**: `${repeat(컬렉션, 범위, 변수, RIGHT)}`

컬렉션의 각 아이템에 대해 지정된 범위를 오른쪽으로 반복합니다.

#### 템플릿

|   | A                                      | B           |
|---|----------------------------------------|-------------|
| 1 | ${repeat(months, B1:B2, m, RIGHT)}     | ${m.month}  |
| 2 |                                        | ${m.sales}  |

#### 결과

|   | A  | B      | C      | D      |
|---|----|--------|--------|--------|
| 1 |    | 1월     | 2월     | 3월     |
| 2 |    | 100    | 150    | 200    |

### 2.4 다중 반복 영역

한 시트에 여러 개의 반복 영역을 사용할 수 있습니다.

#### 열 그룹 분리

서로 다른 열에 위치한 반복 영역은 독립적으로 확장됩니다.

|   | A                                | B             | C | D                                   | E              |
|---|----------------------------------|---------------|---|-------------------------------------|----------------|
| 1 | ${repeat(employees, A2:B2, emp)} |               |   | ${repeat(departments, D2:E2, dept)} |                |
| 2 | ${emp.name}                      | ${emp.salary} |   | ${dept.name}                        | ${dept.budget} |

#### 제한사항

- 반복 영역은 2D 공간(행×열)에서 겹치면 안 됩니다
- 같은 열 범위 내에서 여러 반복 영역을 세로로 배치할 수 있습니다

### 2.5 반복 항목 필드 접근

**문법**: `${변수.필드}`, `${변수.필드.서브필드}`

점(.) 표기법으로 중첩 객체의 필드에 접근합니다.

```
${emp.name}
${emp.department.name}
${emp.address.city}
```

#### 지원 타입

- **객체 필드**: data class, POJO의 프로퍼티/필드
- **Map 키**: Map의 키로 접근
- **getter 메서드**: `getFieldName()` 형태의 getter

### 2.6 명시적 파라미터 형식

repeat 마커의 모든 파라미터에 명시적으로 이름을 지정할 수 있습니다.

#### 문법

```
${repeat(collection=컬렉션, range=범위, var=변수, direction=방향, empty=대체범위)}
```

#### 예시

```
${repeat(collection=employees, range=A2:C2, var=emp)}
${repeat(collection=months, range=B1:B2, var=m, direction=RIGHT)}
${repeat(collection=items, range=A3:C3, var=item, direction=DOWN, empty=A10:C10)}
```

#### 수식 형태

```
=TBEG_REPEAT(collection=employees, range=A2:C2, var=emp)
=TBEG_REPEAT(collection=items, range=A3:C3, var=item, direction=DOWN, empty=A10:C10)
```

#### 파라미터 생략

명시적 형식에서 선택적 파라미터는 생략하거나, `NULL` 또는 빈 값으로 지정할 수 있습니다. 아래 세 가지는 모두 동일합니다.

```
${repeat(collection=items, range=A2:C2, empty=A10:C10)}           // var 생략
${repeat(collection=items, range=A2:C2, var=NULL, empty=A10:C10)} // var=NULL
${repeat(collection=items, range=A2:C2, var=, empty=A10:C10)}     // var= (빈 값)
```

#### 혼합 사용 불가

위치 기반과 명시적 파라미터는 혼합할 수 없습니다. 하나의 파라미터라도 이름을 명시하면 모든 파라미터에 이름을 명시해야 합니다.

```
// 올바른 예
${repeat(items, A2:C2, item, DOWN, A10:C10)}                                    // 모두 위치 기반
${repeat(collection=items, range=A2:C2, var=item, direction=DOWN, empty=A10:C10)} // 모두 명시적

// 잘못된 예 (오류 발생)
${repeat(items, A2:C2, item, empty=A10:C10)}         // 혼합 불가
${repeat(items, A2:C2, var=item, direction=DOWN)}   // 혼합 불가
```

#### 위치 기반 파라미터 생략

위치 기반 형식에서 중간 파라미터를 생략하려면 빈 값으로 두면 됩니다.

```
// direction(4번째)을 생략하고 empty(5번째)만 지정
${repeat(items, A2:C2, item, , A10:C10)}

// var(3번째)와 direction(4번째)을 생략
${repeat(items, A2:C2, , , A10:C10)}

// image에서 position(2번째)을 생략하고 size(3번째)만 지정
${image(logo, , 200:150)}
```

### 2.7 빈 컬렉션 처리 (empty)

**문법**: `${repeat(컬렉션, 범위, 변수, 방향, 대체범위)}`

컬렉션이 비어있을 때 대체 셀 범위의 내용을 표시합니다.

#### 기본 동작 (empty 미지정)

컬렉션이 비어있고 `empty` 파라미터가 없으면, 반복 영역 크기에 맞는 빈 행(DOWN 모드) 또는 빈 열(RIGHT 모드)이 1개 출력됩니다.

- **빈 행/열의 범위**: 엑셀 전체 행이 아닌 반복 영역(range)에 해당하는 셀들만 빈 값으로 출력됩니다.
- **예**: `range=A2:C2`인 경우 A, B, C 열의 셀만 빈 값이 되며, D열 이후는 영향받지 않습니다.

#### empty 파라미터 사용

컬렉션이 비어있을 때 지정된 셀 범위의 내용을 대신 표시합니다.

#### 템플릿

|     | A                                               | B               | C             |
|-----|-------------------------------------------------|-----------------|---------------|
| 1   | ${repeat(employees, A2:C2, emp, DOWN, A10:C10)} |                 |               |
| 2   | ${emp.name}                                     | ${emp.position} | ${emp.salary} |
| ... |                                                 |                 |               |
| 10  | (데이터가 없습니다)                                     |                 |               |

#### 데이터 (빈 컬렉션)

```kotlin
mapOf("employees" to emptyList<Employee>())
```

#### 결과

|   | A           | B | C |
|---|-------------|---|---|
| 1 |             |   |   |
| 2 | (데이터가 없습니다) |   |   |

> **참고**:
> - A10:C10의 내용과 스타일이 A2:C2 위치에 복사됩니다.
> - A10:C10 원본 셀은 결과 파일에서 빈 셀로 처리됩니다.
> - empty 범위가 단일 셀이고 반복 영역이 더 크면 자동으로 셀이 병합됩니다.

#### 단일 셀 병합 예제

empty 범위가 단일 셀이면 반복 영역 전체를 병합하여 해당 내용을 표시합니다.

**템플릿**

|     | A                                           | B               | C             |
|-----|---------------------------------------------|-----------------|---------------|
| 1   | ${repeat(employees, A2:C2, emp, DOWN, A10)} |                 |               |
| 2   | ${emp.name}                                 | ${emp.position} | ${emp.salary} |
| ... |                                             |                 |               |
| 10  | 데이터가 없습니다                                   |                 |               |

- **A10**: 단일 셀에 메시지 작성 (A10:C10이 아닌 A10만 지정)

**결과 (빈 컬렉션)**

<table>
  <tr><th></th><th>A</th><th>B</th><th>C</th></tr>
  <tr><td>1</td><td></td><td></td><td></td></tr>
  <tr><td>2</td><td colspan="3" style="text-align:center">데이터가 없습니다</td></tr>
</table>

- A2:C2 영역이 자동으로 병합되고 A10의 내용이 표시됩니다.

#### empty 범위 지정 방식

```
${repeat(items, A2:C3, item, DOWN, A10:C11)}     // 일반 범위
${repeat(items, A2:C3, item, DOWN, $A$10:$C$11)} // 절대 좌표 ($ 무시)
${repeat(items, A2:C3, item, DOWN, 'Sheet2'!A1:C1)} // 다른 시트 참조
```

#### 위치 파라미터 방식

명시적 파라미터 이름 없이 5번째 파라미터로 지정할 수도 있습니다.

```
${repeat(items, A2:C3, item, DOWN, A10:C11)}
=TBEG_REPEAT(items, A2:C3, item, DOWN, A10:C11)
```

### 2.8 관련 요소 자동 조정

반복 영역이 확장되면 영향 받는 Excel 요소들의 좌표와 범위가 자동으로 조정됩니다.

#### 자동 조정되는 요소

| 요소     | 조정 내용                                  |
|--------|----------------------------------------|
| 수식 참조  | 셀 참조(예: `=SUM(A1:A10)`)가 확장된 범위에 맞게 조정 |
| 차트     | 데이터 소스 범위가 확장된 데이터에 맞게 조정              |
| 피벗 테이블 | 소스 데이터 범위가 확장된 데이터에 맞게 조정              |
| 병합 셀   | 반복 영역 외부의 병합 셀 위치가 조정                  |
| 조건부 서식 | 적용 범위가 확장된 영역에 맞게 조정                   |

#### 위치 이동 및 범위 확장

반복 영역이 확장되면:
- 반복 영역 아래에 있는 요소는 확장된 만큼 아래로 이동합니다.
- 반복 영역을 참조하는 수식은 확장된 전체 영역을 참조하게 됩니다.

**템플릿**

|   | A                                | B             |
|---|----------------------------------|---------------|
| 1 | ${repeat(items, A2:B2, item)}    |               |
| 2 | ${item.name}                     | ${item.value} |
| 3 | 합계                               | =SUM(B2:B2)   |

**결과** (items가 3개인 경우)

|   | A   | B           |
|---|-----|-------------|
| 1 |     |             |
| 2 | 항목1 | 100         |
| 3 | 항목2 | 200         |
| 4 | 항목3 | 300         |
| 5 | 합계  | =SUM(B2:B4) |

> 3행에 있던 합계 행이 5행으로 이동하고, 수식 `=SUM(B2:B2)`도 확장된 범위 `=SUM(B2:B4)`를 참조합니다.

#### 수식 참조 유형별 동작

| 참조 유형 | 예시 | 확장 동작 |
|----------|------|----------|
| 상대 참조 | `B3:B3` | 확장됨 (`B3:B5`) |
| 절대 참조 | `$B$3:$B$3` | 유지됨 (확장 안 함) |
| 행 절대 참조 | `B$3:B$3` | 유지됨 (DOWN 방향 확장 안 함) |
| 열 절대 참조 | `$B3:$B3` | 확장됨 (DOWN 방향 `$B3:$B5`) |
| 다른 시트 참조 | `Sheet2!B3:B3` | 해당 시트의 repeat 확장이 반영됨 |

**예시: 절대 참조로 확장 제어**

```
=SUM(B3:B3)      -> =SUM(B3:B5)     // 상대 참조: 확장됨
=SUM($B$3:$B$3)  -> =SUM($B$3:$B$3) // 절대 참조: 그대로 유지
=SUM($B3:$B3)    -> =SUM($B3:$B5)   // 열만 절대: 행 방향 확장됨
```

**예시: 다른 시트의 repeat 영역 참조**

Sheet2에 repeat 영역이 있고 3개의 항목으로 확장되면, Sheet1에서 Sheet2를 참조하는 수식도 함께 확장됩니다.

```
=SUM(Sheet2!B3:B3)       -> =SUM(Sheet2!B3:B5)
=SUM('Data Sheet'!B3:B3) -> =SUM('Data Sheet'!B3:B5)
```

---

## 3. 이미지 삽입

### 3.1 기본 이미지

**문법**: `${image(이름)}`

마커가 있는 셀(또는 병합 영역)에 이미지를 삽입합니다.

#### 템플릿

|   | A              | B               |
|---|----------------|-----------------|
| 1 | ${image(logo)} | 회사명: ${company} |
| 2 | (병합된 셀)        |                 |

#### 데이터

```kotlin
val provider = simpleDataProvider {
    value("company", "(주)휴넷")
    image("logo", logoBytes)
}
```

### 3.2 위치 지정

**문법**: `${image(이름, 위치)}`

이미지를 삽입할 셀 위치를 직접 지정합니다.

```
${image(logo, B2)}      // B2 셀에 삽입
${image(stamp, D5:F8)}  // D5:F8 범위에 삽입
```

### 3.3 크기 지정

**문법**: `${image(이름, 위치, 크기)}`

이미지 크기를 지정합니다. 크기 미지정 시 셀/범위에 맞춤이 기본값입니다.

| 크기 표기                 | 설명                 |
|-----------------------|--------------------|
| `fit` 또는 `0:0`        | 셀/범위에 맞춤 (기본값)     |
| `original` 또는 `-1:-1` | 원본 크기              |
| `200:150`             | 너비 200픽셀, 높이 150픽셀 |
| `200:-1`              | 너비 200픽셀, 높이 비율 유지 |
| `-1:150`              | 높이 150픽셀, 너비 비율 유지 |
| `0:-1`                | 셀 너비에 맞추고 높이 비율 유지 |
| `-1:0`                | 셀 높이에 맞추고 너비 비율 유지 |

```
${image(logo, B2)}            // 셀 크기에 맞춤 (기본값)
${image(logo, B2, fit)}       // 셀 크기에 맞춤
${image(logo, B2, original)}  // 원본 크기
${image(logo, B2, 200:150)}   // 200×150 픽셀
```

### 3.4 명시적 파라미터 형식

모든 파라미터에 이름을 명시적으로 지정할 수 있습니다.

```
${image(name=logo)}
${image(name=logo, position=B2)}
${image(name=logo, position=B2:D4, size=fit)}
${image(name=logo, size=200:150)}  // position 생략
```

수식 형태:
```
=TBEG_IMAGE(name=logo)
=TBEG_IMAGE(name=logo, position=B2, size=original)
```

---

## 4. 컬렉션 크기

**문법**: `${size(컬렉션)}` 또는 `${size(collection=컬렉션)}`

컬렉션의 아이템 수를 표시합니다.

#### 템플릿

|   | A                           |
|---|-----------------------------|
| 1 | 총 직원 수: ${size(employees)}명 |

#### 결과 (employees가 5명인 경우)

|   | A          |
|---|------------|
| 1 | 총 직원 수: 5명 |

---

## 5. 수식 내 변수

Excel 수식 내에서 변수를 사용할 수 있습니다.

### 5.1 HYPERLINK

**문법**: `=HYPERLINK("${url}", "${text}")`

```
=HYPERLINK("${linkUrl}", "${linkText}")
```

### 5.2 동적 범위

**문법**: `=SUM(B${startRow}:B${endRow})`

수식 내 셀 참조에 변수를 사용하여 동적 범위를 지정합니다.

#### 템플릿

|   | A  | B                               |
|---|----|---------------------------------|
| 1 | 시작 | ${startRow}                     |
| 2 | 끝  | ${endRow}                       |
| 3 | 합계 | =SUM(B\${startRow}:B\${endRow}) |

#### 데이터

```kotlin
mapOf("startRow" to 5, "endRow" to 10)
```

#### 결과

|   | A      | B              |
|---|--------|----------------|
| 1 | 시작     | 5              |
| 2 | 끝      | 10             |
| 3 | 합계     | =SUM(B5:B10)   |

---

## 6. 수식 형태 마커

일부 마커는 수식 형태로도 사용할 수 있습니다.

| 텍스트 형태                       | 수식 형태                           |
|------------------------------|---------------------------------|
| `${repeat(col, range, var)}` | `=TBEG_REPEAT(col, range, var)` |
| `${image(name)}`             | `=TBEG_IMAGE(name)`             |
| `${size(col)}`               | `=TBEG_SIZE(col)`               |

**장점**: 범위나 셀을 지정할 때 Excel의 셀 참조 기능(클릭, 드래그 선택 등)을 활용할 수 있습니다.

> **참고**: 수식 형태 마커는 Excel에서 `#NAME?` 에러로 표시됩니다. 이는 정상이며, 생성 시 올바르게 처리됩니다.

### 6.1 수식 형태 반복 마커

```
=TBEG_REPEAT(employees, A2:C2, emp)
=TBEG_REPEAT(months, B1:B2, m, RIGHT)
```

### 6.2 수식 형태 이미지 마커

```
=TBEG_IMAGE(logo)
=TBEG_IMAGE(logo, B2:D4)
=TBEG_IMAGE(logo, B2, 200:150)
```

### 6.3 수식 형태 크기 마커

```
=TBEG_SIZE(employees)
```

---

## 서식 유지

템플릿에 적용된 모든 서식은 생성된 Excel에 그대로 유지됩니다.

### 유지되는 서식

- 셀 정렬 (가로/세로)
- 글꼴 (이름, 크기, 굵기, 기울임, 밑줄, 색상)
- 채우기 색상
- 테두리
- 숫자 서식
- 조건부 서식

### 반복 영역 서식

반복 영역의 템플릿 행에 적용된 서식은 모든 반복 행에 동일하게 적용됩니다.

---

## 다음 단계

- [API 레퍼런스](./api-reference.md) - 클래스 및 메서드 상세
- [설정 옵션](./configuration.md) - TbegConfig 옵션
- [기본 예제](../examples/basic-examples.md) - 다양한 사용 예제
